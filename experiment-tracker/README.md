# Experiment tracking

One purpose of the _XAI Demonstrator_ is to serve as a platform for academic research and user testing.
Thus, it includes the facilities to record data for later analysis.

As this is the setting the _XAI Demonstrator_ was developed for, we assume that it is embedded
into a web-based experimentation platform such as [oTree](https://www.otree.org/).
You will not necessarily have to spin up your own _XAI Demonstrator_ instance, but you will need
to deploy additional services along with your experiment platform to record and collect the data.

## How do I record data?

To **track the requests to and responses of any _XAI Demonstrator_ use case,** you can route the requests
through an instance of the [`experiment-proxy`](./experiment-proxy/README.md) service.
This has the benefit that you do not need to make any changes to the use case or its configuration.
See [here](./experiment-proxy/README.md) for instructions on how to set up and configure an
 [`experiment-proxy`](./experiment-proxy/README.md) instance. For a large number of experiment
settings, this is more than sufficient.

If you would like to **record additional data that is not part of the request or the response,** 
you can use the `record_data()` function provided by the [`xaidemo`](../common/backend-utils/README.md)
utilities package that is a default dependency of all _XAI Demonstrator_ use cases:

```python
from xaidemo.tracking.record import record_data

def some_function_that_is_called_within_the_use_case(important_value):
    record_data(key="internal_state", value={"value": important_value})
```
You will find this data within the record under `data[key]` along with some metadata.
Please see [here](../common/backend-utils/xaidemo/tracking/README.md) for more detailed information.

Note that you _must_ set `EXPERIMENT=1` on the use case instance that you use for your experiment
and instrument the FastAPI app to actually record any data:

```python
from xaidemo import tracking

app = FastAPI(...)
tracking.instrument_app(app)
```

You also need to configure the `COLLECTOR_URL` environment variable. For further information, including
a more detailed example, see [here](../common/backend-utils/xaidemo/tracking/README.md).

## How do I collect and access the recorded data?

The [`data-collector`](./data-collector/README.md) service receives the data and stores it
as records in a database. It isn't deployed along with the regular _XAI Demonstrator_ deployments,
but you will have to set up your own instance. For more information, see
[here](./data-collector/README.md).

All data that stems from the same original request will be stored
as a single record with a unique ID. Usually, _XAI Demonstrator_ backends return some kind of
ID in their responses (e.g., a `prediction_id` or `explanation_id`) that can be used to later
identify the associated record. That's probably the easiest option in most circumstances.
Note that the IDs generated by the use cases are _not_ the record ID. Instead, you need to
search for it in the data collected by the [`experiment-proxy`](./experiment-proxy/README.md)
that is stored under `record[data]["tracked"]`.
For more information, see [here](./data-collector/README.md).

### Alternative for advanced users

If you're familiar with _OpenTelemetry_, you can instrument your experiment code as well as
the HTTP client you use to make requests to the _XAI Demonstrator_ to pass along an _OpenTelemetry_
context. The record ID is derived from the context information, and you can obtain it as follows
from within the context:

```python
from xaidemo.tracking.record import get_record_id

record_id = get_record_id()
```

This allows you to immediately know the record ID, even before making any calls. You can find
an example in `experiment-tracker/tests/integration/test_end_to_end.py`.

Please note that it is not sufficient to initiate a new span but that you need to initiate a
new context _for each request_. If that sounds very confusing, we suggest you use the method
described above to retrospectively find the record ID to avoid issues during data collection.

## See it in action by running the integration tests

Spin up the local version with a dummy use case:
```bash
cd experiment-tracker
docker-compose --env-file .env.test up
```

Then, you can run the integration tests:
```bash
cd tests
./run.sh
```

`experiment-tracker/docker-compose.yml` shows how to set the
environment variables for each of the involved services.
The tests in `experiment-tracker/tests/integration` document common scenarios and show
how data is recorded, transmitted, stored, and retrieved.

## Is this reliable? Will it affect the performance of the use case?

In principle, recording the data is reliable. We have taken care to surface any issues (such
as attempts to store data that is not JSON-serializable) as early as possible so that any
issues most likely be discovered while setting up an experiment.

However, since the data is transferred to the collector only _after_ the response has been
returned and plenty of things can go wrong when transmitting data across a network,
there is no guarantee that all data sent out is actually recorded.

For the same reason, recording data should only have a minimal performance impact:
Both the [`experiment-proxy`](./experiment-proxy/README.md) and instrumented use cases
only send out data after the response has been returned to the user. This is by far the 
most time-consuming part. The overhead while servicing a request is kept to a minimum
and should be negligible compared to the computations performed by _XAI Demonstrator_ use cases.

## How does it work?

The experiment tracking capabilities are provided by the 
[`xaidemo.tracking`](../common/backend-utils/xaidemo/tracking/README.md) package in combination
with the two services [`experiment-proxy`](./experiment-proxy/README.md) and
[`data-collector`](./data-collector/README.md) described above.

Both the proxy and the data collector are built on FastAPI (similar to the _XAI Demonstrator_
use cases but with much less code) and are best understood by having a look at the source code.

[`xaidemo.tracking`](../common/backend-utils/xaidemo/tracking/README.md)'s `instrument_app()` adds a
[middleware](https://fastapi.tiangolo.com/tutorial/middleware/) to a FastAPI application that makes
sure that all the data recorded during a request is sent to the data collector after the response has
been sent.

Under the hood, the _XAI Demonstrator_'s experiment tracking is built on

- [OpenTelemetry](https://opentelemetry.io/) for context management
- [`aiohttp`](https://docs.aiohttp.org/en/stable/) to handle the requests between services (via `xaidemo.http_client`)
- [Apache CouchDB](https://couchdb.apache.org/) for data storage
